@{
    ViewBag.Title = "Gestión de Expedientes";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    #expedientes-hero .actions-row {
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }

    #expedientes-hero .btn-toolbar {
        display: flex;
        gap: 12px;
        flex-wrap: nowrap;
    }

        #expedientes-hero .btn-toolbar .btn + .btn {
            margin-left: 12px;
        }

    .btn-eq {
        height: 44px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
    }

    @@media (max-width: 1199px) {
        .btn-eq {
            min-width: 180px;
        }
    }

    @@media (max-width: 991px) {
        #expedientes-hero .btn-toolbar {
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn-eq {
            min-width: calc(50% - 6px);
        }
    }

    @@media (max-width: 767px) {
        #expedientes-hero .actions-row {
            justify-content: flex-start;
            margin-top: 10px;
        }

        #expedientes-hero .btn-toolbar {
            width: 100%;
        }

            #expedientes-hero .btn-toolbar .btn {
                flex: 1;
            }

        .btn-eq {
            min-width: 100%;
            width: 100%;
        }
    }
</style>

<section class="section-padding" id="expedientes-hero" style="padding-top:40px">
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-sm-8">
                <h1 class="ser-title">Gestión de expedientes</h1>
                <hr class="botm-line">
                <p>Administra los expedientes clínicos de pacientes. Filtra por paciente, rango de fechas o tipo de consulta; revisa datos personales, historial clínico, diagnósticos y archivos adjuntos.</p>
            </div>
            <div class="col-md-4 col-sm-4 actions-row">
                <div class="btn-toolbar" role="toolbar" aria-label="Acciones de expedientes">
                    <a href="#" class="btn btn-appoint btn-eq" id="btnNuevoExpediente"><i class="fa fa-folder-open"></i> Nuevo expediente</a>
                    <a href="#" class="btn btn-form btn-eq" id="btnNuevoPaciente"><i class="fa fa-user-plus"></i> Nuevo paciente</a>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="expedientes-filtros" class="section-padding" style="padding-top:10px">
    <div class="container">
        <form method="get" id="frmFiltros">
            <div class="panel panel-default">
                <div class="panel-heading"><strong>Filtros de búsqueda</strong></div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-4 col-sm-6">
                            <div class="form-group">
                                <label>Paciente</label>
                                <div class="input-group">
                                    <select class="form-control" name="paciente" id="ddlPacientes">
                                        <option value="">-- Todos --</option>
                                    </select>
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" id="btnAddPacienteInline" title="Agregar paciente"><i class="fa fa-plus"></i></button>
                                    </span>
                                </div>
                                <span class="help-block">Busca por paciente ya registrado o añade uno nuevo.</span>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="form-group">
                                <label>Tipo de consulta</label>
                                <select class="form-control" name="tipoConsulta" id="ddlTiposConsulta">
                                    <option value="">-- Todos --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6">
                            <div class="form-group">
                                <label>Desde</label>
                                <input type="date" class="form-control" name="fechaDesde">
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-6">
                            <div class="form-group">
                                <label>Hasta</label>
                                <input type="date" class="form-control" name="fechaHasta">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-sm-6">
                            <div class="form-group">
                                <label>Texto libre</label>
                                <input type="text" class="form-control" name="textoLibre" placeholder="Buscar en notas, diagnóstico, #expediente…">
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6 text-right" style="margin-top:25px">
                            <button type="submit" class="btn btn-form"><i class="fa fa-search"></i> Buscar</button>
                            <button type="reset" class="btn btn-default"><i class="fa fa-eraser"></i> Limpiar</button>
                            <button type="button" id="btnExport" class="btn btn-default"><i class="fa fa-download"></i> Exportar CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<section id="expedientes-lista" class="section-padding" style="padding-top:0">
    <div class="container">
        <div class="panel panel-default">
            <div class="panel-heading">
                <strong>Resultados</strong>
                <span class="text-muted" id="lblResultados">(0 registro(s))</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="tblExpedientes">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Paciente</th>
                            <th>Identificación</th>
                            <th>Fecha</th>
                            <th>Tipo de consulta</th>
                            <th>Diagnóstico</th>
                            <th>Adjuntos</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="8" class="text-center text-muted">No se encontraron resultados.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Modal: Detalle Expediente -->
<div class="modal fade" id="modalDetalle" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Detalle del expediente</h4>
            </div>
            <div class="modal-body" id="detalleBody">
                <div class="text-center text-muted">Cargando…</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Adjuntos -->
<div class="modal fade" id="modalAdjuntos" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Archivos adjuntos</h4>
            </div>
            <div class="modal-body">
                <div id="adjuntosLista" class="well well-sm" style="max-height:240px; overflow:auto">Cargando…</div>
                <form method="post" enctype="multipart/form-data" id="frmAdjunto">
                    <input type="hidden" name="ExpedienteId" id="Adj_ExpedienteId">
                    <div class="form-group">
                        <label for="Archivo">Archivo (PDF/JPG/PNG, máx. 10MB)</label>
                        <input type="file" class="form-control" id="Archivo" name="Archivo" accept="application/pdf,image/*" required />
                    </div>
                    <div class="form-group">
                        <label for="Descripcion">Descripción</label>
                        <input type="text" class="form-control" id="Descripcion" name="Descripcion" maxlength="120" />
                    </div>
                    <button type="submit" class="btn btn-form"><i class="fa fa-upload"></i> Subir</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nuevo Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"><i class="fa fa-user-plus"></i> Registrar nuevo paciente</h4>
            </div>
            <div class="modal-body">
                <form id="frmPaciente" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Pac_Identificacion">Identificación (cédula)</label>
                                <input type="text" class="form-control" id="Pac_Identificacion" name="Identificacion" maxlength="20" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Pac_Nombre">Nombre completo</label>
                                <input type="text" class="form-control" id="Pac_Nombre" name="Nombre" maxlength="120" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="Pac_FechaNac">Fecha de nacimiento</label>
                                <input type="date" class="form-control" id="Pac_FechaNac" name="FechaNacimiento" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="Pac_Sexo">Sexo</label>
                                <select id="Pac_Sexo" name="Sexo" class="form-control" required>
                                    <option value="">Seleccione…</option>
                                    <option>Femenino</option>
                                    <option>Masculino</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="Pac_Telefono">Teléfono</label>
                                <input type="tel" class="form-control" id="Pac_Telefono" name="Telefono" maxlength="20">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Pac_Email">Email</label>
                                <input type="email" class="form-control" id="Pac_Email" name="Email" maxlength="120">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Pac_Direccion">Dirección</label>
                                <input type="text" class="form-control" id="Pac_Direccion" name="Direccion" maxlength="200">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Pac_ContactoEmerg">Contacto de emergencia</label>
                                <input type="text" class="form-control" id="Pac_ContactoEmerg" name="ContactoEmergencia" maxlength="120">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Pac_Notas">Notas</label>
                                <input type="text" class="form-control" id="Pac_Notas" name="Notas" maxlength="200" placeholder="Alergias, condiciones, etc.">
                            </div>
                        </div>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="Pac_Consent" required> Confirmo consentimiento informado del paciente para el tratamiento de datos.
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-form" id="btnGuardarPaciente"><i class="fa fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nuevo Expediente -->
<div class="modal fade" id="modalExpediente" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"><i class="fa fa-folder-open"></i> Nuevo expediente</h4>
            </div>
            <div class="modal-body">
                <form id="frmExpediente" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Exp_Paciente">Paciente</label>
                                <select class="form-control" id="Exp_Paciente" name="Paciente" required>
                                    <option value="">Seleccione…</option>
                                </select>
                                <span class="help-block">Si el paciente no existe, crea uno con "Nuevo paciente".</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="Exp_Fecha">Fecha de atención</label>
                                <input type="date" class="form-control" id="Exp_Fecha" name="Fecha" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="Exp_TipoConsulta">Tipo de consulta</label>
                                <select class="form-control" id="Exp_TipoConsulta" name="TipoConsulta" required>
                                    <option value="">Seleccione…</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Exp_Motivo">Motivo / Resumen</label>
                                <input type="text" class="form-control" id="Exp_Motivo" name="Motivo" maxlength="180" placeholder="Motivo de consulta" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Exp_Dx">Diagnóstico principal</label>
                                <input type="text" class="form-control" id="Exp_Dx" name="Diagnostico" maxlength="160" placeholder="Ej. F41.1 Trastorno de ansiedad" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Exp_Historial">Historial clínico</label>
                                <textarea class="form-control" id="Exp_Historial" name="Historial" rows="4" placeholder="Antecedentes, condiciones, alergias…"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="Exp_Notas">Notas de sesión</label>
                                <textarea class="form-control" id="Exp_Notas" name="Notas" rows="4" placeholder="Intervención, observaciones, plan…"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="Exp_Adjuntos">Adjuntar archivos (opcional)</label>
                                <input type="file" id="Exp_Adjuntos" name="Adjuntos" class="form-control" accept="application/pdf,image/*" multiple>
                                <span class="help-block">PDF/JPG/PNG, máx. 10MB c/u.</span>
                            </div>
                        </div>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="Exp_Consent" required> Confirmo consentimiento informado y política de privacidad aplicada al expediente.
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-form" id="btnGuardarExpediente"><i class="fa fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        // Exportar CSV de la tabla
        document.getElementById('btnExport').addEventListener('click', function () {
            var rows = [];
            var trs = document.querySelectorAll('#tblExpedientes tr');
            trs.forEach(function (tr) {
                var cols = tr.querySelectorAll('th,td');
                var data = [];
                for (var i = 0; i < cols.length - 1; i++) {
                    data.push(cols[i].innerText.trim());
                }
                rows.push(data);
            });
            var csv = rows.map(r => r.join(',')).join('\n');
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url; a.download = 'expedientes.csv';
            a.click();
            URL.revokeObjectURL(url);
        });

        // --- NUEVO: Abrir modales alineados con botones parejos ---
        function abrirModalPaciente(e) { e && e.preventDefault(); $('#modalPaciente').modal('show'); }
        function abrirModalExpediente(e) { e && e.preventDefault(); sincronizarCombosExpediente(); $('#modalExpediente').modal('show'); }

        document.getElementById('btnNuevoPaciente').addEventListener('click', abrirModalPaciente);
        document.getElementById('btnAddPacienteInline').addEventListener('click', abrirModalPaciente);
        document.getElementById('btnNuevoExpediente').addEventListener('click', abrirModalExpediente);

        // Guardar paciente (demo en front-end) y seleccionar en filtros
        document.getElementById('btnGuardarPaciente').addEventListener('click', function () {
            var f = document.getElementById('frmPaciente');
            if (!f.checkValidity()) { f.reportValidity && f.reportValidity(); return; }
            var id = 'P' + Math.random().toString(36).slice(2, 8).toUpperCase();
            var nombre = document.getElementById('Pac_Nombre').value.trim();
            var identificacion = document.getElementById('Pac_Identificacion').value.trim();
            agregarOpcionPaciente(id, nombre + ' (' + identificacion + ')');
            document.getElementById('ddlPacientes').value = id;
            $('#modalPaciente').modal('hide');
            f.reset();
            // TODO: Reemplazar por POST real al servidor y recargar desde BD
        });

        function agregarOpcionPaciente(value, text) {
            var ddl = document.getElementById('ddlPacientes');
            var opt = document.createElement('option');
            opt.value = value; opt.text = text; ddl.appendChild(opt);
        }

        function sincronizarCombosExpediente() {
            // Copia las opciones de Pacientes y Tipos al modal de Expediente
            var srcPac = document.getElementById('ddlPacientes');
            var dstPac = document.getElementById('Exp_Paciente');
            dstPac.innerHTML = '<option value="">Seleccione…</option>';
            Array.prototype.slice.call(srcPac.options).forEach(function (o) {
                if (o.value === '') return; // saltar "-- Todos --"
                var n = document.createElement('option');
                n.value = o.value; n.text = o.text; dstPac.appendChild(n);
            });

            var srcTipo = document.getElementById('ddlTiposConsulta');
            var dstTipo = document.getElementById('Exp_TipoConsulta');
            dstTipo.innerHTML = '<option value="">Seleccione…</option>';
            Array.prototype.slice.call(srcTipo.options).forEach(function (o) {
                if (o.value === '') return;
                var n = document.createElement('option');
                n.value = o.value; n.text = o.text; dstTipo.appendChild(n);
            });
        }

        // Guardar expediente (demo en front-end): inserta fila en la tabla
        document.getElementById('btnGuardarExpediente').addEventListener('click', function () {
            var f = document.getElementById('frmExpediente');
            if (!f.checkValidity()) { f.reportValidity && f.reportValidity(); return; }
            var tbl = document.getElementById('tblExpedientes').querySelector('tbody');
            // remover fila "sin resultados" si existe
            if (tbl.children.length === 1 && tbl.children[0].querySelectorAll('td').length === 1) { tbl.innerHTML = ''; }

            var idx = tbl.children.length + 1;
            var pacienteText = document.getElementById('Exp_Paciente').selectedOptions[0].text;
            var identificacion = (pacienteText.match(/\((.*?)\)$/) || [, '']).pop();
            var fecha = document.getElementById('Exp_Fecha').value || '';
            var tipoText = document.getElementById('Exp_TipoConsulta').selectedOptions[0].text;
            var dx = document.getElementById('Exp_Dx').value.trim();
            var adjuntos = document.getElementById('Exp_Adjuntos').files.length;

            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + idx + '</td>' +
                '<td>' + pacienteText.replace(/\s*\(.*\)$/, '') + '</td>' +
                '<td>' + identificacion + '</td>' +
                '<td>' + fecha + '</td>' +
                '<td>' + tipoText + '</td>' +
                '<td>' + dx + '</td>' +
                '<td>' + adjuntos + '</td>' +
                '<td class="text-right">' +
                '<a class="btn btn-xs btn-default js-ver"><i class="fa fa-eye"></i></a> ' +
                '<a class="btn btn-xs btn-default js-adjuntos"><i class="fa fa-paperclip"></i></a>' +
                '</td>';
            tbl.appendChild(tr);

            // actualizar contador de resultados
            document.getElementById('lblResultados').textContent = '(' + tbl.children.length + ' registro(s))';

            $('#modalExpediente').modal('hide');
            f.reset();
            // TODO: Reemplazar por POST real y refrescar tabla desde servidor
        });

    })();
</script>




